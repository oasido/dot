#!/usr/bin/env bash

if [[ "$OSTYPE" == "darwin"* ]]; then
  # macOS - use osascript
  current_volume=$(osascript -e 'input volume of (get volume settings)' 2>/dev/null)

  if [[ ! "$current_volume" =~ ^[0-9]+$ ]]; then
    current_volume=0
  fi

  # toggle mic volume
  if [ "$current_volume" -eq 0 ]; then
    osascript -e 'set volume input volume 100'
    osascript -e 'display notification "Microphone Unmuted" with title "Mic Toggle"'
  else
    osascript -e 'set volume input volume 0'
    osascript -e 'display notification "Microphone Muted" with title "Mic Toggle"'
  fi

else
  # linux - use pulsemixer
  source_id=$(pulsemixer --list-sources | grep -i "Name: RODE NT-USB Analog Stereo" | sed -n 's/.*ID: source-\([0-9]*\).*/\1/p')
  virtual_id=$(pulsemixer --list-sources | grep -i "virtual-microphone" | sed -n 's/.*ID: source-\([0-9]*\).*/\1/p')

  pulsemixer --id "source-$source_id" --toggle-mute
  pulsemixer --id "source-$virtual_id" --set-volume 100

  mute_status=$(pulsemixer --get-mute --id "source-$source_id")

  if [ "$mute_status" -eq 0 ]; then
    notify-send --icon=gtk-info "Microphone unmuted"
  else
    notify-send --icon=gtk-info "Microphone muted"
  fi

fi
