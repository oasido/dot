#!/usr/bin/env bash
# save and restore sioyek sessions with optional group support
set -eu

# where we store session files
SESSION_DIR="${HOME}/.sioyek-sessions"
DEFAULT_SESSION="${SESSION_DIR}/default"
mkdir -p "$SESSION_DIR"

# helper: get all pdfs with open file handles via lsof
get_paths_from_lsof() {
  # get all sioyek process ids
  pgrep -x sioyek | while read -r pid; do
    # skip if pid is empty
    [[ -z "$pid" ]] && continue

    # list all open files for this process
    lsof -p "$pid" -Fn 2>/dev/null | while read -r line; do
      # extract filename from lsof output (lines starting with 'n')
      if [[ $line == n* ]]; then
        # remove the 'n' prefix
        file="${line:1}"
        # only print pdf files
        [[ $file == *.pdf ]] && echo "$file"
      fi
    done
  done | sort -u # sort and remove duplicates
}

# helper: get sioyek window titles via accessibility api
get_sioyek_windows() {
  osascript -e 'tell application "System Events" to tell process "sioyek" to get name of every window' 2>/dev/null
}

# helper: parse window titles and match to full paths
match_windows_to_paths() {
  local window_titles="$1"
  local lsof_paths="$2"

  # if no window titles, return empty
  [[ -z "$window_titles" ]] && return

  # window titles are comma-separated, e.g., "file1.pdf, file2.pdf"
  # convert to array by splitting on comma
  local IFS=','
  local -a titles=($window_titles)

  # for each window title (basename), find matching path in lsof results
  for title in "${titles[@]}"; do
    # trim whitespace
    title=$(echo "$title" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

    # match against lsof paths (basename must match)
    echo "$lsof_paths" | grep "/${title}$"
  done | sort -u
}

# main dump function: get pdfs from visible sioyek windows
dump() {
  local lsof_paths
  lsof_paths=$(get_paths_from_lsof)

  # try to get window titles via accessibility api
  local window_titles
  if window_titles=$(get_sioyek_windows); then
    [[ -n "${DEBUG:-}" ]] && echo "[DEBUG] Using window title API" >&2

    # match window titles to full paths
    local matched_paths
    matched_paths=$(match_windows_to_paths "$window_titles" "$lsof_paths")

    # if we got matches, return them
    if [[ -n "$matched_paths" ]]; then
      echo "$matched_paths"
      return 0
    fi
  fi

  # fallback: permission denied or no windows found
  [[ -n "${DEBUG:-}" ]] && echo "[DEBUG] Falling back to lsof method" >&2

  # check if we need to show permission message
  if ! get_sioyek_windows >/dev/null 2>&1 && pgrep -x sioyek >/dev/null; then
    echo "âš ï¸  Accessibility permission not granted - using fallback method (may include cached files)" >&2
    echo "   To fix: System Settings â†’ Privacy & Security â†’ Accessibility â†’ Add Terminal" >&2
  fi

  echo "$lsof_paths"
}

save() {
  local name="${1:-default}"
  local debug_flag=""

  # check for --debug flag
  if [[ "$name" == "--debug" ]]; then
    export DEBUG=1
    name="${2:-default}"
  elif [[ "${2:-}" == "--debug" ]]; then
    export DEBUG=1
  fi

  # write all open pdfs to session file
  dump >"${SESSION_DIR}/${name}"
}

restore() {
  local name="${1:-default}"
  local file="${SESSION_DIR}/${name}"

  # check if session file exists
  [[ -f "$file" ]] || {
    echo "no session found: $name" >&2
    exit 1
  }

  # open each pdf in the session file
  while read -r pdf; do
    # use open command for macos
    open -a Sioyek "$pdf"
  done <"$file"
}

list_sessions() {
  # iterate through all session files sorted by modification time
  find "$SESSION_DIR" -type f -print0 | xargs -0 stat -f "%m %N" | sort -rn | cut -d' ' -f2- | while read -r file; do
    # extract just the session name from full path
    local session
    session=$(basename "$file")

    # get file modification time and count of pdfs
    local mtime
    mtime=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M" "$file")

    local count
    count=$(wc -l <"$file" | tr -d ' ')

    # print session header
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸ“š Session: $session"
    echo "   Modified: $mtime | PDFs: $count"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # print each pdf with line number
    nl -w2 -s'. ' "$file" | sed 's/^/   /'
    echo
  done
}

# handle command line arguments
case "${1:-}" in
save)
  save "${2:-default}" "${3:-}"
  ;;
r | restore | open)
  restore "${2:-default}"
  ;;
l | ls | list)
  list_sessions
  ;;
*)
  echo "usage: sio {save|restore|open} [session-name] [--debug] | {l|ls|list}" >&2
  exit 1
  ;;
esac
